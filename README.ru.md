# Хаб подписок V2Ray

Безопасная система агрегирования и управления подписками V2Ray с подходом Docker-first.

## Возможности
- **Централизованный хаб**: объединяет несколько подписок (Hiddify, Xray и др.) в одну.
- **Админ-панель**: управление пользователями, upstream-источниками и статическими нодами.
- **Безопасность**: секретный токен для каждого пользователя, без публичной регистрации, шифрованное хранение токенов.
- **Производительность**: кэширование, параллельная загрузка, дедупликация.
- **Docker-first**: простой деплой с Nginx и автоматизацией SSL.

## Быстрый старт (Dev)

1. Клонируйте репозиторий.
2. Скопируйте и отредактируйте `.env`:
   ```bash
   cp .env.example .env
   ```
3. Поднимите стек (первый запуск собирает образ, последующие используют кэш):
   ```bash
   docker compose -f compose.dev.yml up -d
   ```
4. Запустите Nuxt dev вручную внутри контейнера `app`:
   ```bash
   docker exec -it ss-app ash
   bun dev
   ```
5. Создайте администратора (в другом терминале):
   ```bash
   docker compose -f compose.dev.yml exec app bun run scripts/create-admin.ts --email admin@example.com --password secret
   ```
6. Доступ:
   - `https://localhost/admin` (через Nginx + локальные сертификаты)
   - `http://localhost:3000/admin` (прямой доступ к Nuxt dev server)

## Локальный HTTPS (как в деплое)

Используйте отдельный dev-стек:

```bash
docker compose -f compose.dev.yml up -d
```

Это запускает отдельную dev-композицию (`app`, `mongo`, `nginx`) и использует локальные сертификаты из `nginx/cert-local`.
`DEV_DOMAIN` по умолчанию `localhost` (можно переопределить, например `DEV_DOMAIN=api.localhost`).
Исходники Nuxt примонтированы для hot reload. Кэш зависимостей, кэш Nuxt/Nitro и данные MongoDB сохраняются в именованных Docker-томах.
Запустите dev-сервер вручную:
```bash
docker exec -it ss-app ash
bun dev
```

Доступ:
- `https://localhost/admin`

## Продакшен-деплой

1. Укажите `DOMAIN` и `EMAIL` в `.env`.
2. Инициализируйте SSL-сертификаты:
   ```bash
   chmod +x ops/ssl/init.sh
   ./ops/ssl/init.sh
   ```
3. Соберите и запустите продакшен-стек:
   ```bash
   docker compose -f compose.yml up -d --build
   ```
4. Для обычных перезапусков без пересборки:
   ```bash
   docker compose -f compose.yml up -d
   ```
5. Данные MongoDB сохраняются в именованном Docker-томе.
6. Приложение будет доступно по адресу `https://your-domain.com`.

## Управление

### Управление пользователями
- Войдите в админ-панель.
- Создайте пользователей. Каждый пользователь получает уникальный Subscription URL.
- Передайте этот URL пользователю для клиента V2Ray (v2rayNG, V2Box и т.д.).

### Управление upstream-источниками
- **Global**: применяется ко ВСЕМ пользователям.
- **User**: применяется только к конкретному пользователю.
- Поддерживаются raw-текст списки и base64 ссылки подписок.

### Ротация токена
- В деталях пользователя нажмите "Rotate Token", чтобы сразу инвалидировать старый URL и создать новый.

## Разработка

- Выполните `bun install`
- Выполните `bun dev` для локального dev-сервера (требуется локальный Mongo)
- Выполните `bun test` для unit-тестов

## Архитектура

- **Бэкенд**: Nuxt 3 (Nitro)
- **База данных**: MongoDB (Mongoose)
- **Фронтенд**: Nuxt UI (Tailwind)
- **Безопасность**: хеширование Argon2, шифрование токенов AES-256-GCM, H3-сессии
